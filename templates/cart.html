<!DOCTYPE html>
<html>
<head>
    <title>Your Cart - BookGenie</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="cart-page">
    <h1>üõí Your Cart</h1>

    {% if items %}

        <div class="cart-list" id="cartList">

            {% for item in items %}
            <div class="cart-row"
                 data-id="{{ item._id|string if item._id else item.isbn }}">

                <div class="cart-image">
                    <img src="{{ item.image_url if item.image_url else 'https://via.placeholder.com/150x200?text=No+Cover' }}"
                         alt="{{ item.title }}">
                </div>

                <div class="cart-details">
                    <h3>{{ item.title }}</h3>
                    <p>{{ item.author }}</p>
                    <p>ISBN: {{ item.isbn }}</p>
                    <p class="price">Price: ‚Çπ{{ item.price }}</p>

                    <button class="remove-btn"
                        onclick="removeCartItem('{{ item._id|string if item._id else item.isbn }}')">
                        ‚ùå Remove
                    </button>
                </div>
            </div>
            {% endfor %}

        </div>

        <!-- TOTAL -->
        <div class="cart-total">
            <h2>Total: ‚Çπ{{ total }}</h2>
        </div>

        <!-- ACTION BUTTONS -->
        <div class="cart-actions">

            <button class="buy-btn" onclick="buyCart()">
                üí≥ Buy Now
            </button>

            <button class="clear-btn" onclick="clearCart()">
                üóë Clear Cart
            </button>

        </div>

    {% else %}
        <p class="empty-cart">Your cart is empty üò¢</p>
    {% endif %}

    <br>
    <a href="/" class="back-btn">‚¨Ö Continue Shopping</a>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>

<script>

// ===============================
// BUY FUNCTION (Login Only)
// ===============================
async function buyCart() {

    try {
        const res = await fetch('/api/cart/buy', {
            method: 'POST'
        });

        const data = await res.json();

        if (!data.success) {

            alert(data.message);

            // Guest redirect to login
            if (res.status === 401) {
                window.location.href = "/login";
            }

        } else {
            alert("Order placed successfully üéâ");
            window.location.reload();
        }

    } catch (err) {
        console.error(err);
        alert("Something went wrong ‚ùå");
    }
}


// ===============================
// CLEAR CART
// ===============================
async function clearCart() {

    try {
        const res = await fetch('/api/cart/clear', {
            method: 'POST'
        });

        const data = await res.json();

        if (data.success) {
            alert("Cart cleared ‚úÖ");
            window.location.reload();
        }

    } catch (err) {
        console.error(err);
        alert("Failed to clear cart ‚ùå");
    }
}

</script>

</body>
</html>